<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Perfil - Atlas Sports</title>
  <link rel="stylesheet" href="css/main.css">
  <!-- Cargar Supabase y config -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="js/config.js"></script>
  
  <style>
    /* ESTILOS MUY SIMPLES */
    .profile-simple {
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      text-align: center;
    }
    
    .avatar-simple {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      margin: 0 auto 20px;
      background: linear-gradient(135deg, #5865f2, #eb459e);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 60px;
      color: white;
    }
    
    .username-simple {
      font-size: 32px;
      margin-bottom: 10px;
      color: white;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin: 30px 0;
    }
    
    .stat-box {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: bold;
      color: #5865f2;
      display: block;
    }
    
    .stat-label {
      font-size: 14px;
      color: #cbd5e1;
      margin-top: 5px;
    }
    
    .error-box {
      background: rgba(255, 107, 107, 0.1);
      border: 2px solid #ff6b6b;
      border-radius: 10px;
      padding: 30px;
      margin: 30px 0;
    }
    
    .debug-info {
      background: rgba(255,255,255,0.05);
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 12px;
      text-align: left;
      overflow: auto;
      max-height: 200px;
    }
  </style>
</head>
<body>
  <!-- NAVBAR SIMPLE -->
  <header class="navbar">
    <div class="brand">
      <img src="assets/logo.png" class="logo" alt="Logo Atlas Sports">
      <a href="index.html" style="color: inherit; text-decoration: none;">
        <span>Atlas Sports</span>
      </a>
    </div>
    <nav class="menu">
      <a href="index.html">Inicio</a>
      <a href="profile.html?u=test">Mi Perfil</a>
    </nav>
    <div class="auth">
      <a href="login.html" class="login-btn">Login</a>
      <a href="register.html" class="btn">Registro</a>
    </div>
  </header>

  <!-- CONTENIDO PRINCIPAL -->
  <main class="profile-simple">
    <div id="profileContent">
      <div class="avatar-simple">ü¶Ü</div>
      <h1 class="username-simple" id="username">Cargando...</h1>
      <p id="description">Buscando perfil...</p>
      
      <div class="stats-grid" id="statsContainer">
        <!-- Las estad√≠sticas se cargar√°n aqu√≠ -->
      </div>
      
      <div id="debugArea" class="debug-info">
        <!-- Informaci√≥n de debug -->
      </div>
    </div>
  </main>

  <script>
    // ==============================
    // 1. CONFIGURACI√ìN DESDE config.js
    // ==============================
    console.log("üöÄ Iniciando profile.html con config centralizada");
    
    // Obtener Supabase desde config.js
    const supabase = getSupabaseClient();
    
    // ==============================
    // 2. FUNCI√ìN PRINCIPAL
    // ==============================
    async function loadProfile() {
      const debugArea = document.getElementById('debugArea');
      const usernameElement = document.getElementById('username');
      const statsContainer = document.getElementById('statsContainer');
      
      // Obtener username de la URL
      const urlParams = new URLSearchParams(window.location.search);
      const requestedUsername = urlParams.get('u');
      
      debugArea.innerHTML = `Buscando usuario: ${requestedUsername || 'NO ESPECIFICADO'}<br>`;
      
      if (!requestedUsername) {
        usernameElement.textContent = "Error: Falta username";
        statsContainer.innerHTML = `
          <div class="error-box">
            <h3>‚ùå ERROR</h3>
            <p>Debes especificar un usuario en la URL:</p>
            <p><strong>profile.html?u=nombreusuario</strong></p>
            <p>Ejemplo: <a href="profile.html?u=test">profile.html?u=test</a></p>
          </div>
        `;
        return;
      }
      
      debugArea.innerHTML += `Conectando a Supabase...<br>`;
      
      try {
        // Cargar Supabase
        const { createClient } = window.supabase;
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        debugArea.innerHTML += `‚úÖ Supabase cargado<br>`;
        
        // PRIMERO: Verificar todos los usuarios
        debugArea.innerHTML += `üîç Buscando TODOS los usuarios...<br>`;
        
        const { data: allUsers, error: allError } = await supabase
          .from('profiles')
          .select('id, username')
          .limit(10);
        
        if (allError) {
          debugArea.innerHTML += `‚ùå Error al buscar usuarios: ${allError.message}<br>`;
          throw new Error(allError.message);
        }
        
        debugArea.innerHTML += `‚úÖ Encontrados ${allUsers?.length || 0} usuarios<br>`;
        
        if (allUsers && allUsers.length > 0) {
          debugArea.innerHTML += `üìã Usuarios disponibles:<br>`;
          allUsers.forEach(user => {
            debugArea.innerHTML += `&nbsp;&nbsp;‚Ä¢ ${user.username} (ID: ${user.id})<br>`;
          });
        }
        
        // SEGUNDO: Buscar usuario espec√≠fico
        debugArea.innerHTML += `<br>üîç Buscando usuario "${requestedUsername}"...<br>`;
        
        const { data: profile, error } = await supabase
          .from('profiles')
          .select('*')
          .eq('username', requestedUsername)
          .single();
        
        if (error) {
          debugArea.innerHTML += `‚ùå Error espec√≠fico: ${error.message}<br>`;
          debugArea.innerHTML += `‚ö†Ô∏è Intentando b√∫squeda alternativa...<br>`;
          
          // Intentar b√∫squeda m√°s flexible
          const { data: allProfiles } = await supabase
            .from('profiles')
            .select('*');
          
          if (allProfiles && allProfiles.length > 0) {
            const found = allProfiles.find(p => 
              p.username.toLowerCase() === requestedUsername.toLowerCase()
            );
            
            if (found) {
              debugArea.innerHTML += `‚úÖ ¬°Encontrado! (coincidencia flexible)<br>`;
              displayProfile(found);
              return;
            }
          }
          
          throw new Error(`Usuario "${requestedUsername}" no encontrado`);
        }
        
        debugArea.innerHTML += `‚úÖ ¬°Usuario encontrado!<br>`;
        displayProfile(profile);
        
      } catch (error) {
        debugArea.innerHTML += `<br>‚ùå‚ùå‚ùå ERROR CR√çTICO:<br>`;
        debugArea.innerHTML += `${error.message}<br>`;
        
        usernameElement.textContent = "Error üò¢";
        statsContainer.innerHTML = `
          <div class="error-box">
            <h3>ERROR DE CONEXI√ìN</h3>
            <p><strong>${error.message}</strong></p>
            <p>Posibles soluciones:</p>
            <ol style="text-align: left; margin-left: 20px;">
              <li>Verifica que Supabase est√© activo</li>
              <li>Revisa la consola del navegador (F12)</li>
              <li>Intenta con un username diferente</li>
              <li>Registra un nuevo usuario primero</li>
            </ol>
            <div style="margin-top: 20px;">
              <a href="register.html" class="btn">Registrar Nuevo Usuario</a>
            </div>
          </div>
        `;
      }
    }
    
    // ==============================
    // 3. MOSTRAR PERFIL
    // ==============================
    function displayProfile(profile) {
      console.log("üéâ PERFIL ENCONTRADO:", profile);
      
      // Actualizar informaci√≥n b√°sica
      document.getElementById('username').textContent = profile.username;
      document.title = `${profile.username} - Atlas Sports`;
      
      // Calcular estad√≠sticas
      const kills = profile.kills || 0;
      const deaths = profile.muertes || 0;
      const kdRatio = deaths > 0 ? (kills / deaths).toFixed(2) : kills.toFixed(2);
      
      // Mostrar estad√≠sticas
      document.getElementById('statsContainer').innerHTML = `
        <div class="stat-box">
          <span class="stat-value">${profile.torneos_participados || 0}</span>
          <span class="stat-label">Torneos Jugados</span>
        </div>
        <div class="stat-box">
          <span class="stat-value">${profile.torneos_ganados || 0}</span>
          <span class="stat-label">Torneos Ganados</span>
        </div>
        <div class="stat-box">
          <span class="stat-value">${profile.partidas_ganadas || 0}</span>
          <span class="stat-label">Partidas Ganadas</span>
        </div>
        <div class="stat-box">
          <span class="stat-value">${kdRatio}</span>
          <span class="stat-label">K/D Ratio</span>
        </div>
      `;
      
      // Informaci√≥n adicional
      document.getElementById('description').textContent = 
        profile.description || `Jugador de Duck Game - ${kills} kills`;
      
      // Mostrar en debug
      document.getElementById('debugArea').innerHTML += `
        <br>‚úÖ PERFIL CARGADO CORRECTAMENTE:<br>
        ‚Ä¢ ID: ${profile.id}<br>
        ‚Ä¢ Username: ${profile.username}<br>
        ‚Ä¢ Kills: ${kills}<br>
        ‚Ä¢ Miembro desde: ${new Date(profile.created_at).toLocaleDateString()}<br>
      `;
    }
    
    // ==============================
    // 4. TEST DE CONEXI√ìN R√ÅPIDO
    // ==============================
    async function quickTest() {
      console.log("üîß Ejecutando test r√°pido...");
      const debugArea = document.getElementById('debugArea');
      
      try {
        // Test 1: Cargar Supabase
        if (!window.supabase) {
          throw new Error("Supabase no se carg√≥ del CDN");
        }
        
        debugArea.innerHTML += `‚úÖ Supabase CDN cargado<br>`;
        
        // Test 2: Crear cliente
        const { createClient } = window.supabase;
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        debugArea.innerHTML += `‚úÖ Cliente Supabase creado<br>`;
        
        // Test 3: Consulta simple
        const { data, error } = await supabase
          .from('profiles')
          .select('count')
          .limit(1);
        
        if (error) throw error;
        
        debugArea.innerHTML += `‚úÖ Conexi√≥n a Supabase OK<br>`;
        return true;
        
      } catch (error) {
        debugArea.innerHTML += `‚ùå Test fall√≥: ${error.message}<br>`;
        return false;
      }
    }
    
    // ==============================
    // 5. INICIALIZACI√ìN
    // ==============================
    document.addEventListener('DOMContentLoaded', async () => {
      console.log("üìÑ DOM cargado, iniciando...");
      
      // Ejecutar test r√°pido primero
      const testPassed = await quickTest();
      
      if (testPassed) {
        // Si el test pasa, cargar perfil
        await loadProfile();
      } else {
        // Si falla el test, mostrar error claro
        document.getElementById('profileContent').innerHTML = `
          <div class="error-box">
            <h2>üö® ERROR DE CONEXI√ìN</h2>
            <p>No se pudo conectar a Supabase. Esto puede deberse a:</p>
            <ul style="text-align: left; margin-left: 20px;">
              <li>Claves de API incorrectas</li>
              <li>Proyecto de Supabase desactivado</li>
              <li>Problemas de red/CORS</li>
              <li>Tabla 'profiles' no existe</li>
            </ul>
            <div style="margin-top: 30px;">
              <h3>üõ†Ô∏è SOLUCI√ìN R√ÅPIDA:</h3>
              <p>Usa este usuario de prueba:</p>
              <a href="profile.html?u=testuser" class="btn" style="margin: 10px;">
                profile.html?u=testuser
              </a>
              <p style="margin-top: 20px; font-size: 14px;">
                O crea un nuevo usuario: 
                <a href="register.html">Reg√≠strate aqu√≠</a>
              </p>
            </div>
          </div>
        `;
      }
    });
  </script>
</body>
</html>
